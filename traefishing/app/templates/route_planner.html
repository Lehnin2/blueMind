{% extends "base.html" %}

{% block title %}Route Planner{% endblock %}

{% block head %}
<style>
    .form-container {
        max-width: 800px;
        margin: 0 auto;
    }
    .map-preview {
        height: 400px;
        border-radius: 10px;
        overflow: hidden;
        margin-top: 20px;
    }
    .port-selector {
        margin-top: 20px;
        display: flex;
        gap: 20px;
    }
    .port-list {
        flex: 1;
        background-color: rgba(0, 50, 50, 0.7);
        border-radius: 10px;
        padding: 15px;
        max-height: 300px;
        overflow-y: auto;
    }
    .port-list h3 {
        margin-bottom: 10px;
        color: var(--accent-color);
    }
    .port-item {
        padding: 8px 10px;
        border-radius: 5px;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    .port-item:hover {
        background-color: rgba(255, 255, 255, 0.1);
    }
    .port-item.selected {
        background-color: rgba(56, 173, 169, 0.3);
        border-left: 3px solid var(--accent-color);
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-card">
    <div class="card-header">
        <h2>Route Planner</h2>
    </div>
    <div class="card-content">
        <p>Plan a route between two points in the sea. The system will calculate the optimal path while avoiding land and respecting protected areas.</p>
        
        <div class="form-container">
            <form action="/calculate-route" method="post">
                <div class="form-row">
                    <div class="form-group">
                        <label for="start_lat">Starting Latitude</label>
                        <input type="number" id="start_lat" name="start_lat" step="0.0001" required 
                               value="{{ request.query_params.start_lat if request.query_params.start_lat else '36.8183' }}">
                    </div>
                    <div class="form-group">
                        <label for="start_lon">Starting Longitude</label>
                        <input type="number" id="start_lon" name="start_lon" step="0.0001" required 
                               value="{{ request.query_params.start_lon if request.query_params.start_lon else '10.3053' }}">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="end_lat">Destination Latitude</label>
                        <input type="number" id="end_lat" name="end_lat" step="0.0001" required 
                               value="{{ request.query_params.end_lat if request.query_params.end_lat else '35.8245' }}">
                    </div>
                    <div class="form-group">
                        <label for="end_lon">Destination Longitude</label>
                        <input type="number" id="end_lon" name="end_lon" step="0.0001" required 
                               value="{{ request.query_params.end_lon if request.query_params.end_lon else '10.6346' }}">
                    </div>
                </div>
                
                <div class="form-group">
                    <button type="submit" class="btn btn-primary">Calculate Route</button>
                </div>
            </form>
            
            <div class="port-selector">
                <div class="port-list">
                    <h3>Starting Point</h3>
                    <div class="port-item" data-lat="36.8183" data-lon="10.3053">La Goulette (Tunis)</div>
                    <div class="port-item" data-lat="37.2744" data-lon="9.8739">Bizerte</div>
                    <div class="port-item" data-lat="35.8245" data-lon="10.6346">Sousse</div>
                    <div class="port-item" data-lat="34.7478" data-lon="10.7661">Sfax</div>
                    <div class="port-item" data-lat="33.8881" data-lon="10.1186">Gabès</div>
                    <div class="port-item" data-lat="33.5031" data-lon="11.1122">Zarzis</div>
                    <div class="port-item" data-lat="35.7784" data-lon="10.8320">Monastir</div>
                    <div class="port-item" data-lat="35.5047" data-lon="11.0622">Mahdia</div>
                </div>
                
                <div class="port-list">
                    <h3>Destination</h3>
                    <div class="port-item" data-lat="36.8183" data-lon="10.3053">La Goulette (Tunis)</div>
                    <div class="port-item" data-lat="37.2744" data-lon="9.8739">Bizerte</div>
                    <div class="port-item" data-lat="35.8245" data-lon="10.6346">Sousse</div>
                    <div class="port-item" data-lat="34.7478" data-lon="10.7661">Sfax</div>
                    <div class="port-item" data-lat="33.8881" data-lon="10.1186">Gabès</div>
                    <div class="port-item" data-lat="33.5031" data-lon="11.1122">Zarzis</div>
                    <div class="port-item" data-lat="35.7784" data-lon="10.8320">Monastir</div>
                    <div class="port-item" data-lat="35.5047" data-lon="11.0622">Mahdia</div>
                </div>
            </div>
            
            <!-- Add map-click coordinate selector and current location button -->
            <div class="coordinate-controls" style="margin: 10px 0;">
                <label><input type="radio" name="markerType" value="start" checked> Set Start by Map Click</label>
                <label style="margin-left:15px;"><input type="radio" name="markerType" value="end"> Set End by Map Click</label>
                <button type="button" id="current-loc-btn" class="btn btn-secondary" style="margin-left: 20px;">Use Current Location</button>
            </div>
            
            <div id="map-preview" class="map-preview"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />

<script>
    // Initialize map
    const mapPreview = L.map('map-preview').setView([35.5, 10.5], 7);
    
    // Add OpenStreetMap tiles
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(mapPreview);
    
    // Add markers for start and end points
    const startMarker = L.marker([36.8183, 10.3053], {
        draggable: true,
        title: "Starting Point",
        icon: L.icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34]
        })
    }).addTo(mapPreview);
    
    const endMarker = L.marker([35.8245, 10.6346], {
        draggable: true,
        title: "Destination",
        icon: L.icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34]
        })
    }).addTo(mapPreview);
    
    // Draw a line between the points
    const routeLine = L.polyline([[36.8183, 10.3053], [35.8245, 10.6346]], {
        color: 'blue',
        weight: 3,
        opacity: 0.7,
        dashArray: '5, 10'
    }).addTo(mapPreview);
    
    // Update form inputs and line when markers are moved
    function updateRoute() {
        const startLatLng = startMarker.getLatLng();
        const endLatLng = endMarker.getLatLng();
        
        // Update form inputs
        document.getElementById('start_lat').value = startLatLng.lat.toFixed(4);
        document.getElementById('start_lon').value = startLatLng.lng.toFixed(4);
        document.getElementById('end_lat').value = endLatLng.lat.toFixed(4);
        document.getElementById('end_lon').value = endLatLng.lng.toFixed(4);
        
        // Update route line
        routeLine.setLatLngs([startLatLng, endLatLng]);
    }
    
    startMarker.on('dragend', updateRoute);
    endMarker.on('dragend', updateRoute);
    
    // Update markers when form inputs change
    const startLatInput = document.getElementById('start_lat');
    const startLonInput = document.getElementById('start_lon');
    const endLatInput = document.getElementById('end_lat');
    const endLonInput = document.getElementById('end_lon');
    
    function updateMarkers() {
        const startLat = parseFloat(startLatInput.value);
        const startLon = parseFloat(startLonInput.value);
        const endLat = parseFloat(endLatInput.value);
        const endLon = parseFloat(endLonInput.value);
        
        if (!isNaN(startLat) && !isNaN(startLon)) {
            startMarker.setLatLng([startLat, startLon]);
        }
        
        if (!isNaN(endLat) && !isNaN(endLon)) {
            endMarker.setLatLng([endLat, endLon]);
        }
        
        // Update route line
        routeLine.setLatLngs([startMarker.getLatLng(), endMarker.getLatLng()]);
        
        // Fit map to show both markers
        const bounds = L.latLngBounds(startMarker.getLatLng(), endMarker.getLatLng());
        mapPreview.fitBounds(bounds, { padding: [50, 50] });
    }
    
    startLatInput.addEventListener('change', updateMarkers);
    startLonInput.addEventListener('change', updateMarkers);
    endLatInput.addEventListener('change', updateMarkers);
    endLonInput.addEventListener('change', updateMarkers);
    
    // Initialize with form values
    updateMarkers();
    
    // Handle port selection
    const startPortItems = document.querySelectorAll('.port-list:first-child .port-item');
    const endPortItems = document.querySelectorAll('.port-list:last-child .port-item');
    
    startPortItems.forEach(item => {
        item.addEventListener('click', function() {
            // Remove selected class from all items
            startPortItems.forEach(i => i.classList.remove('selected'));
            
            // Add selected class to clicked item
            this.classList.add('selected');
            
            // Update form and marker
            const lat = parseFloat(this.dataset.lat);
            const lon = parseFloat(this.dataset.lon);
            
            startLatInput.value = lat;
            startLonInput.value = lon;
            startMarker.setLatLng([lat, lon]);
            
            // Update route line
            updateMarkers();
        });
    });
    
    endPortItems.forEach(item => {
        item.addEventListener('click', function() {
            // Remove selected class from all items
            endPortItems.forEach(i => i.classList.remove('selected'));
            
            // Add selected class to clicked item
            this.classList.add('selected');
            
            // Update form and marker
            const lat = parseFloat(this.dataset.lat);
            const lon = parseFloat(this.dataset.lon);
            
            endLatInput.value = lat;
            endLonInput.value = lon;
            endMarker.setLatLng([lat, lon]);
            
            // Update route line
            updateMarkers();
        });
    });

    // Add map click handler to set start or end marker based on selected radio button
    mapPreview.on('click', function(e) {
        const lat = e.latlng.lat;
        const lon = e.latlng.lng;
        const markerType = document.querySelector('input[name="markerType"]:checked').value;
        if (markerType === 'start') {
            startMarker.setLatLng(e.latlng);
            startLatInput.value = lat.toFixed(4);
            startLonInput.value = lon.toFixed(4);
        } else {
            endMarker.setLatLng(e.latlng);
            endLatInput.value = lat.toFixed(4);
            endLonInput.value = lon.toFixed(4);
        }
        updateRoute();
    });

    // Add current location button handler to set start marker to user's location
    document.getElementById('current-loc-btn').addEventListener('click', function() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function(position) {
                const lat = position.coords.latitude;
                const lon = position.coords.longitude;
                startMarker.setLatLng([lat, lon]);
                startLatInput.value = lat.toFixed(4);
                startLonInput.value = lon.toFixed(4);
                updateRoute();
            }, function(error) {
                alert('Unable to retrieve your location: ' + error.message);
            });
        } else {
            alert('Geolocation is not supported by your browser.');
        }
    });
</script>
{% endblock %}

<!-- Add this to the existing route_planner.html file -->
<style>
    /* Custom map controls for mobile */
    .custom-map-controls {
        position: absolute;
        bottom: 10px;
        right: 10px;
        z-index: 1000;
        background: rgba(0, 50, 50, 0.8);
        padding: 5px;
        border-radius: 4px;
        display: flex;
        flex-direction: column;
    }
    .map-type-btn {
        padding: 8px 12px;
        margin: 3px;
        border: none;
        background: rgba(255, 255, 255, 0.2);
        color: white;
        border-radius: 3px;
        cursor: pointer;
        font-size: 0.9em;
        transition: background 0.3s;
    }
    .map-type-btn:hover, .map-type-btn.active {
        background: var(--accent-color);
    }
    .map-container {
        position: relative;
    }
</style>

<!-- Add this inside the map container div -->
<div class="custom-map-controls">
    <button class="map-type-btn active" data-map-type="Standard Map">Standard</button>
    <button class="map-type-btn" data-map-type="Satellite">Satellite</button>
    <button class="map-type-btn" data-map-type="Ocean">Ocean</button>
</div>

<!-- Add this script at the end of the file -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Find the map iframe
        const mapContainer = document.querySelector('.map-container');
        const mapIframe = mapContainer.querySelector('iframe');
        const mapTypeButtons = document.querySelectorAll('.map-type-btn');
        
        if (mapIframe) {
            // Wait for iframe to load
            mapIframe.onload = function() {
                console.log("Map iframe loaded");
                
                // Add click handlers for map type buttons
                mapTypeButtons.forEach(button => {
                    button.addEventListener('click', function() {
                        const mapType = this.getAttribute('data-map-type');
                        console.log("Switching to map type:", mapType);
                        
                        // Remove active class from all buttons
                        mapTypeButtons.forEach(btn => btn.classList.remove('active'));
                        // Add active class to clicked button
                        this.classList.add('active');
                        
                        try {
                            // Access the iframe document
                            const iframeDocument = mapIframe.contentDocument || mapIframe.contentWindow.document;
                            
                            // Find the layer control in the iframe
                            const layerInputs = iframeDocument.querySelectorAll('.leaflet-control-layers-selector');
                            const layerLabels = iframeDocument.querySelectorAll('.leaflet-control-layers-base label span');
                            
                            // Match the button's map type with the layer control label
                            for (let i = 0; i < layerInputs.length; i++) {
                                if (layerLabels[i] && layerLabels[i].textContent.trim() === mapType) {
                                    // Click the radio button to change the layer
                                    layerInputs[i].click();
                                    break;
                                }
                            }
                        } catch (error) {
                            console.error("Error switching map layer:", error);
                        }
                    });
                });
            };
        }
    });
</script>