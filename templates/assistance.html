{% extends "base.html" %}

{% block title %}Assistance{% endblock %}

{% block head %}
<style>
    .chat-container {
        background: linear-gradient(135deg, rgba(50, 30, 0, 0.8), rgba(60, 30, 10, 0.8));
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        border: 1px solid rgba(205, 133, 63, 0.3);
        height: 70vh;
        display: flex;
        flex-direction: column;
    }
    
    .chat-header {
        background: rgba(139, 69, 19, 0.8);
        padding: 15px;
        color: white;
        font-weight: 600;
        display: flex;
        align-items: center;
    }
    
    .chat-header i {
        margin-right: 10px;
        font-size: 1.2rem;
    }
    
    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        display: flex;
        flex-direction: column;
        gap: 15px;
    }
    
    .message {
        max-width: 80%;
        padding: 12px 15px;
        border-radius: 15px;
        position: relative;
        animation: fadeIn 0.3s ease;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .user-message {
        align-self: flex-end;
        background: rgba(205, 133, 63, 0.8);
        color: white;
        border-bottom-right-radius: 5px;
    }
    
    .bot-message {
        align-self: flex-start;
        background: rgba(255, 255, 255, 0.1);
        color: white;
        border-bottom-left-radius: 5px;
    }
    
    .message-time {
        font-size: 0.7rem;
        opacity: 0.7;
        margin-top: 5px;
        text-align: right;
    }
    
    .chat-input {
        padding: 15px;
        background: rgba(0, 0, 0, 0.2);
        display: flex;
        gap: 10px;
    }
    
    .chat-input input {
        flex: 1;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(205, 133, 63, 0.3);
        border-radius: 30px;
        padding: 10px 15px;
        color: white;
    }
    
    .chat-input input::placeholder {
        color: rgba(255, 255, 255, 0.5);
    }
    
    .chat-input button {
        background: rgba(205, 133, 63, 0.8);
        border: none;
        border-radius: 30px;
        width: 45px;
        height: 45px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .chat-input button:hover {
        background: rgba(139, 69, 19, 0.9);
    }
    
    .suggestions {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 20px;
    }
    
    .suggestion-chip {
        background: rgba(205, 133, 63, 0.3);
        border: 1px solid rgba(205, 133, 63, 0.5);
        border-radius: 30px;
        padding: 8px 15px;
        font-size: 0.9rem;
        color: white;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .suggestion-chip:hover {
        background: rgba(205, 133, 63, 0.5);
    }
    
    .typing-indicator {
        display: flex;
        align-items: center;
        gap: 5px;
        color: rgba(255, 255, 255, 0.7);
        font-size: 0.9rem;
        margin-top: 5px;
    }
    
    .typing-dot {
        width: 8px;
        height: 8px;
        background: rgba(205, 133, 63, 0.8);
        border-radius: 50%;
        animation: typingAnimation 1.5s infinite ease-in-out;
    }
    
    .typing-dot:nth-child(1) { animation-delay: 0s; }
    .typing-dot:nth-child(2) { animation-delay: 0.3s; }
    .typing-dot:nth-child(3) { animation-delay: 0.6s; }
    
    @keyframes typingAnimation {
        0%, 100% { opacity: 0.3; transform: scale(0.8); }
        50% { opacity: 1; transform: scale(1); }
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="display-5 fw-bold text-white mb-3">Assistant Virtuel</h1>
            <p class="text-white-50 mb-4">Posez vos questions sur la réglementation de la pêche et obtenez des réponses précises et personnalisées.</p>
        </div>
    </div>
    
    <div class="row">
        <div class="col-lg-8">
            <div class="chat-container">
                <div class="chat-header">
                    <i class="bi bi-robot"></i>
                    <span>Assistant Réglementaire</span>
                </div>
                
                <div class="chat-messages" id="chatMessages">
                    <!-- Message de bienvenue initial -->
                    <div class="message bot-message">
                        <div class="message-content">
                            Bonjour ! Je suis votre assistant virtuel spécialisé dans la réglementation de la pêche. Comment puis-je vous aider aujourd'hui ?
                        </div>
                        <div class="message-time">Aujourd'hui, maintenant</div>
                    </div>
                    
                    <!-- Les messages s'ajouteront ici dynamiquement -->
                </div>
                
                <div class="chat-input">
                    <input type="text" id="messageInput" placeholder="Posez votre question..." autocomplete="off">
                    <button id="sendButton"><i class="bi bi-send"></i></button>
                </div>
            </div>
            
            <div class="suggestions mt-3">
                <div class="suggestion-chip">Quelles sont les tailles minimales ?</div>
                <div class="suggestion-chip">Périodes de pêche autorisées</div>
                <div class="suggestion-chip">Quotas journaliers</div>
                <div class="suggestion-chip">Zones interdites</div>
                <div class="suggestion-chip">Comment obtenir un permis ?</div>
            </div>
        </div>
        
        <div class="col-lg-4 mt-4 mt-lg-0">
            <div class="card bg-dark text-white border-0 rounded-4 shadow-sm">
                <div class="card-header bg-transparent border-bottom border-secondary">
                    <h5 class="mb-0"><i class="bi bi-info-circle me-2"></i>Aide</h5>
                </div>
                <div class="card-body">
                    <p>Notre assistant virtuel peut vous aider avec :</p>
                    <ul class="mb-0">
                        <li>Les réglementations spécifiques par espèce</li>
                        <li>Les périodes d'ouverture et de fermeture</li>
                        <li>Les zones autorisées et interdites</li>
                        <li>Les tailles minimales et quotas</li>
                        <li>Les techniques de pêche autorisées</li>
                        <li>Les démarches administratives</li>
                    </ul>
                </div>
            </div>
            
            <div class="card bg-dark text-white border-0 rounded-4 shadow-sm mt-4">
                <div class="card-header bg-transparent border-bottom border-secondary">
                    <h5 class="mb-0"><i class="bi bi-clock-history me-2"></i>Historique</h5>
                </div>
                <div class="card-body">
                    <p class="text-white-50 small">Vos conversations récentes :</p>
                    <div id="conversationHistory">
                        <p class="text-center text-white-50 small">Aucune conversation récente</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const chatMessages = document.getElementById('chatMessages');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const suggestionChips = document.querySelectorAll('.suggestion-chip');
        
        // Fonction pour ajouter un message à la conversation
        function addMessage(content, isUser = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user-message' : 'bot-message'}`;
            
            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';
            messageContent.textContent = content;
            
            const messageTime = document.createElement('div');
            messageTime.className = 'message-time';
            messageTime.textContent = 'Aujourd\'hui, ' + new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            messageDiv.appendChild(messageContent);
            messageDiv.appendChild(messageTime);
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // Fonction pour afficher l'indicateur de frappe
        function showTypingIndicator() {
            const typingDiv = document.createElement('div');
            typingDiv.className = 'typing-indicator';
            typingDiv.id = 'typingIndicator';
            
            typingDiv.innerHTML = `
                <span>Assistant est en train d'écrire</span>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
            `;
            
            chatMessages.appendChild(typingDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // Fonction pour masquer l'indicateur de frappe
        function hideTypingIndicator() {
            const indicator = document.getElementById('typingIndicator');
            if (indicator) {
                indicator.remove();
            }
        }
        
        // Fonction pour envoyer un message
        async function sendMessage(message) {
            if (!message.trim()) return;
            
            // Afficher le message de l'utilisateur
            addMessage(message, true);
            messageInput.value = '';
            
            // Afficher l'indicateur de frappe
            showTypingIndicator();
            
            try {
                // Envoyer la requête à l'API
                const formData = new FormData();
                formData.append('message', message);
                
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                // Masquer l'indicateur de frappe
                hideTypingIndicator();
                
                // Afficher la réponse
                addMessage(data.text || 'Désolé, je n\'ai pas pu traiter votre demande.');
                
                // Afficher les suggestions si disponibles
                if (data.suggestions && data.suggestions.length > 0) {
                    const suggestionsDiv = document.querySelector('.suggestions');
                    suggestionsDiv.innerHTML = '';
                    
                    data.suggestions.forEach(suggestion => {
                        const chip = document.createElement('div');
                        chip.className = 'suggestion-chip';
                        chip.textContent = suggestion;
                        chip.addEventListener('click', () => sendMessage(suggestion));
                        suggestionsDiv.appendChild(chip);
                    });
                }
                
            } catch (error) {
                console.error('Erreur:', error);
                hideTypingIndicator();
                addMessage('Désolé, une erreur est survenue lors du traitement de votre demande.');
            }
        }
        
        // Événement pour envoyer un message
        sendButton.addEventListener('click', () => {
            sendMessage(messageInput.value);
        });
        
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage(messageInput.value);
            }
        });
        
        // Événements pour les suggestions
        suggestionChips.forEach(chip => {
            chip.addEventListener('click', () => {
                sendMessage(chip.textContent);
            });
        });
    });
</script>
{% endblock %}