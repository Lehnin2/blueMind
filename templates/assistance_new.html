{% extends "base.html" %}

{% block title %}Assistant Intelligent{% endblock %}

{% block head %}
<!-- Inclure le script pour l'assistant vocal -->
<script src="{{ url_for('static', path='/js/voice-assistant.js') }}"></script>
<!-- Inclure les scripts pour l'assistant et la recherche DeepSearch -->
<style>
    .chat-container {
        background: linear-gradient(135deg, rgba(50, 30, 0, 0.8), rgba(60, 30, 10, 0.8));
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        border: 1px solid rgba(205, 133, 63, 0.3);
        height: 80vh;
        display: flex;
        flex-direction: column;
    }
    
    .chat-header {
        background: rgba(139, 69, 19, 0.8);
        padding: 15px;
        color: white;
        font-weight: 600;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    
    .chat-header-left {
        display: flex;
        align-items: center;
    }
    
    .chat-header i {
        margin-right: 10px;
        font-size: 1.2rem;
    }
    
    .chat-header-actions {
        display: flex;
        gap: 10px;
    }
    
    .header-btn {
        background: rgba(0, 0, 0, 0.2);
        border: none;
        border-radius: 50%;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .header-btn:hover {
        background: rgba(0, 0, 0, 0.4);
    }
    
    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        display: flex;
        flex-direction: column;
        gap: 15px;
    }
    
    .message {
        max-width: 80%;
        padding: 12px 15px;
        border-radius: 15px;
        position: relative;
        animation: fadeIn 0.3s ease;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .user-message {
        align-self: flex-end;
        background: rgba(205, 133, 63, 0.8);
        color: white;
        border-bottom-right-radius: 5px;
    }
    
    .bot-message {
        align-self: flex-start;
        background: rgba(255, 255, 255, 0.1);
        color: white;
        border-bottom-left-radius: 5px;
    }
    
    .message-time {
        font-size: 0.7rem;
        opacity: 0.7;
        margin-top: 5px;
        text-align: right;
    }
    
    .chat-input-container {
        padding: 15px;
        background: rgba(0, 0, 0, 0.2);
    }
    
    .chat-input {
        display: flex;
        gap: 10px;
        position: relative;
    }
    
    .chat-input textarea {
        flex: 1;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(205, 133, 63, 0.3);
        border-radius: 15px;
        padding: 12px 45px 12px 15px;
        color: white;
        resize: none;
        min-height: 50px;
        max-height: 150px;
        overflow-y: auto;
    }
    
    .chat-input textarea::placeholder {
        color: rgba(255, 255, 255, 0.5);
    }
    
    .chat-input-actions {
        position: absolute;
        right: 60px;
        bottom: 10px;
        display: flex;
        gap: 8px;
    }
    
    .input-action-btn {
        background: transparent;
        border: none;
        color: rgba(255, 255, 255, 0.6);
        cursor: pointer;
        transition: all 0.2s ease;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
    }
    
    .input-action-btn:hover {
        background: rgba(255, 255, 255, 0.1);
        color: white;
    }
    
    .chat-input button.send-btn {
        background: rgba(205, 133, 63, 0.8);
        border: none;
        border-radius: 50%;
        width: 45px;
        height: 45px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        cursor: pointer;
        transition: all 0.2s ease;
        align-self: flex-end;
    }
    
    .chat-input button.send-btn:hover {
        background: rgba(139, 69, 19, 0.9);
    }
    
    .suggestions {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 15px;
    }
    
    .suggestion-chip {
        background: rgba(205, 133, 63, 0.3);
        border: 1px solid rgba(205, 133, 63, 0.5);
        border-radius: 30px;
        padding: 8px 15px;
        font-size: 0.9rem;
        color: white;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .suggestion-chip:hover {
        background: rgba(205, 133, 63, 0.5);
    }
    
    .typing-indicator {
        display: flex;
        align-items: center;
        gap: 5px;
        color: rgba(255, 255, 255, 0.7);
        font-size: 0.9rem;
        margin-top: 5px;
    }
    
    .typing-dot {
        width: 8px;
        height: 8px;
        background: rgba(205, 133, 63, 0.8);
        border-radius: 50%;
        animation: typingAnimation 1.5s infinite ease-in-out;
    }
    
    .typing-dot:nth-child(1) { animation-delay: 0s; }
    .typing-dot:nth-child(2) { animation-delay: 0.3s; }
    .typing-dot:nth-child(3) { animation-delay: 0.6s; }
    
    @keyframes typingAnimation {
        0%, 100% { opacity: 0.3; transform: scale(0.8); }
        50% { opacity: 1; transform: scale(1); }
    }
    
    /* Styles pour le panneau lat√©ral */
    .sidebar-card {
        background: linear-gradient(135deg, rgba(50, 30, 0, 0.8), rgba(60, 30, 10, 0.8));
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        border: 1px solid rgba(205, 133, 63, 0.3);
        margin-bottom: 20px;
    }
    
    .sidebar-header {
        background: rgba(139, 69, 19, 0.8);
        padding: 15px;
        color: white;
        font-weight: 600;
        display: flex;
        align-items: center;
    }
    
    .sidebar-content {
        padding: 15px;
    }
    
    .agent-option {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(205, 133, 63, 0.3);
        border-radius: 10px;
        padding: 10px;
        margin-bottom: 10px;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .agent-option:hover, .agent-option.active {
        background: rgba(205, 133, 63, 0.3);
    }
    
    .agent-option-title {
        font-weight: 600;
        margin-bottom: 5px;
    }
    
    .agent-option-desc {
        font-size: 0.9rem;
        opacity: 0.8;
    }
    
    /* Styles pour le modal d'upload de PDF */
    .pdf-preview {
        background: rgba(0, 0, 0, 0.2);
        border-radius: 10px;
        padding: 15px;
        margin-top: 15px;
    }
    
    .pdf-preview-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }
    
    .pdf-file-info {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .pdf-file-icon {
        font-size: 1.5rem;
        color: #e74c3c;
    }
    
    .pdf-file-name {
        font-weight: 600;
    }
    
    .pdf-file-size {
        font-size: 0.8rem;
        opacity: 0.7;
    }
    
    .pdf-preview-actions {
        display: flex;
        gap: 10px;
    }
    
    /* Styles pour l'enregistrement vocal */
    .voice-recording {
        background: rgba(0, 0, 0, 0.2);
        border-radius: 10px;
        padding: 15px;
        margin-top: 15px;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    
    .voice-recording-status {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .voice-recording-indicator {
        width: 12px;
        height: 12px;
        background: #e74c3c;
        border-radius: 50%;
        animation: pulse 1.5s infinite;
    }
    
    @keyframes pulse {
        0% { transform: scale(0.8); opacity: 0.7; }
        50% { transform: scale(1.2); opacity: 1; }
        100% { transform: scale(0.8); opacity: 0.7; }
    }
    
    .voice-recording-time {
        font-family: monospace;
    }
    
    .voice-recording-actions {
        display: flex;
        gap: 10px;
    }
    
    .voice-btn {
        background: rgba(255, 255, 255, 0.1);
        border: none;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .voice-btn:hover {
        background: rgba(255, 255, 255, 0.2);
    }
    
    .voice-btn.stop {
        background: rgba(231, 76, 60, 0.8);
    }
    
    .voice-btn.stop:hover {
        background: rgba(231, 76, 60, 1);
    }
    
    /* Styles pour le modal */
    .custom-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
    }
    
    .custom-modal.show {
        opacity: 1;
        visibility: visible;
    }
    
    .modal-content {
        background: linear-gradient(135deg, rgba(50, 30, 0, 0.95), rgba(60, 30, 10, 0.95));
        border-radius: 15px;
        width: 90%;
        max-width: 500px;
        max-height: 80vh;
        overflow-y: auto;
        padding: 20px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(205, 133, 63, 0.3);
        transform: translateY(20px);
        transition: all 0.3s ease;
    }
    
    .custom-modal.show .modal-content {
        transform: translateY(0);
    }
    
    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid rgba(205, 133, 63, 0.3);
    }
    
    .modal-title {
        font-size: 1.2rem;
        font-weight: 600;
        color: rgba(205, 133, 63, 0.9);
    }
    
    .modal-close {
        background: transparent;
        border: none;
        color: white;
        font-size: 1.5rem;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .modal-close:hover {
        color: rgba(205, 133, 63, 0.9);
    }
    
    .pdf-upload-area {
        border: 2px dashed rgba(205, 133, 63, 0.5);
        border-radius: 10px;
        padding: 30px;
        text-align: center;
        margin-bottom: 20px;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .pdf-upload-area:hover {
        border-color: rgba(205, 133, 63, 0.8);
        background: rgba(205, 133, 63, 0.1);
    }
    
    .pdf-upload-icon {
        font-size: 2.5rem;
        color: rgba(205, 133, 63, 0.7);
        margin-bottom: 15px;
    }
    
    .pdf-upload-text {
        margin-bottom: 10px;
    }
    
    .pdf-upload-hint {
        font-size: 0.9rem;
        opacity: 0.7;
    }
    
    .pdf-upload-input {
        display: none;
    }
    
    /* Styles responsifs */
    @media (max-width: 768px) {
        .chat-container {
            height: 75vh;
        }
        
        .message {
            max-width: 90%;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row mb-3">
        <div class="col-12">
            <h1 class="display-5 fw-bold text-white mb-2">Assistant Intelligent</h1>
            <p class="text-white-50 mb-3">Posez vos questions sur la r√©glementation de la p√™che et obtenez des r√©ponses pr√©cises et personnalis√©es. Utilisez la recherche web pour des informations actualis√©es.</p>
        </div>
    </div>
    
    <div class="row">
        <!-- Panneau principal de chat -->
        <div class="col-lg-8 mb-4">
            <div class="chat-container">
                <div class="chat-header">
                    <div class="chat-header-left">
                        <i class="bi bi-robot"></i>
                        <span>Assistant R√©glementaire</span>
                    </div>
                    <div class="chat-header-actions">
                        <button class="header-btn" id="clearChatBtn" title="Effacer la conversation">
                            <i class="bi bi-trash"></i>
                        </button>
                        <button class="header-btn" id="exportChatBtn" title="Exporter la conversation">
                            <i class="bi bi-download"></i>
                        </button>
                    </div>
                </div>
                
                <div class="chat-messages" id="chatMessages">
                    <!-- Message de bienvenue initial -->
                    <div class="message bot-message">
                        <div class="message-content">
                            Bonjour ! Je suis votre assistant virtuel sp√©cialis√© dans la r√©glementation de la p√™che. Comment puis-je vous aider aujourd'hui ?
                        </div>
                        <div class="message-time">Aujourd'hui, maintenant</div>
                    </div>
                    
                    <!-- Les messages s'ajouteront ici dynamiquement -->
                </div>
                
                <div class="chat-input-container">
                    <div class="chat-input">
                        <textarea id="messageInput" placeholder="Posez votre question..." rows="1"></textarea>
                        <div class="chat-input-actions">
                            <button class="input-action-btn" id="voiceInputBtn" title="Enregistrement vocal">
                                <i class="bi bi-mic"></i>
                            </button>
                            <button class="input-action-btn" id="uploadPdfBtn" title="Importer un PDF">
                                <i class="bi bi-file-earmark-pdf"></i>
                            </button>
                        </div>
                        <button class="send-btn" id="sendButton">
                            <i class="bi bi-send"></i>
                        </button>
                    </div>
                    
                    <!-- Zone d'enregistrement vocal (masqu√©e par d√©faut) -->
                    <div class="voice-recording" id="voiceRecordingContainer" style="display: none;">
                        <div class="voice-recording-status">
                            <div class="voice-recording-indicator"></div>
                            <span>Enregistrement en cours</span>
                            <span class="voice-recording-time" id="recordingTime">00:00</span>
                        </div>
                        <div class="voice-recording-actions">
                            <button class="voice-btn stop" id="stopRecordingBtn">
                                <i class="bi bi-stop-fill"></i>
                            </button>
                            <button class="voice-btn" id="cancelRecordingBtn">
                                <i class="bi bi-x"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Aper√ßu du PDF (masqu√© par d√©faut) -->
                    <div class="pdf-preview" id="pdfPreviewContainer" style="display: none;">
                        <div class="pdf-preview-header">
                            <div class="pdf-file-info">
                                <i class="bi bi-file-earmark-pdf pdf-file-icon"></i>
                                <div>
                                    <div class="pdf-file-name" id="pdfFileName">document.pdf</div>
                                    <div class="pdf-file-size" id="pdfFileSize">1.2 MB</div>
                                </div>
                            </div>
                            <div class="pdf-preview-actions">
                                <button class="input-action-btn" id="removePdfBtn">
                                    <i class="bi bi-x"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="suggestions mt-3">
                        <div class="suggestion-chip">Quelles sont les tailles minimales ?</div>
                        <div class="suggestion-chip">P√©riodes de p√™che autoris√©es</div>
                        <div class="suggestion-chip">Quotas journaliers</div>
                        <div class="suggestion-chip">Zones interdites</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Panneau lat√©ral -->
        <div class="col-lg-4">
            <!-- S√©lection d'agent -->
            <div class="sidebar-card mb-4">
                <div class="sidebar-header">
                    <i class="bi bi-cpu me-2"></i>
                    <span>S√©lection d'agent</span>
                </div>
                <div class="sidebar-content">
                    <div class="agent-option active" data-agent="llama4">
                        <div class="agent-option-title">Llama 4</div>
                        <div class="agent-option-desc">Agent principal avec compr√©hension avanc√©e de la r√©glementation</div>
                    </div>
                    <div class="agent-option" data-agent="expert">
                        <div class="agent-option-title">Expert Juridique</div>
                        <div class="agent-option-desc">Sp√©cialis√© dans les textes de loi et r√©glementations officielles</div>
                    </div>
                    <div class="agent-option" data-agent="local">
                        <div class="agent-option-title">Expert Local</div>
                        <div class="agent-option-desc">Connaissances sp√©cifiques des zones de p√™che r√©gionales</div>
                    </div>
                    <div class="agent-option" data-agent="technique">
                        <div class="agent-option-title">Expert Technique</div>
                        <div class="agent-option-desc">Sp√©cialis√© dans les engins et techniques de p√™che</div>
                    </div>
                </div>
            </div>
            
            <!-- Aide -->
            <div class="sidebar-card mb-4">
                <div class="sidebar-header">
                    <i class="bi bi-info-circle me-2"></i>
                    <span>Aide</span>
                </div>
                <div class="sidebar-content">
                    <p>Notre assistant virtuel peut vous aider avec :</p>
                    <ul class="mb-0">
                        <li>Les r√©glementations sp√©cifiques par esp√®ce</li>
                        <li>Les p√©riodes d'ouverture et de fermeture</li>
                        <li>Les zones autoris√©es et interdites</li>
                        <li>Les tailles minimales et quotas</li>
                        <li>Les techniques de p√™che autoris√©es</li>
                        <li>Les d√©marches administratives</li>
                    </ul>
                    <div class="mt-3">
                        <p class="mb-2"><i class="bi bi-mic me-2"></i> Utilisez la fonction vocale pour dicter vos questions</p>
                        <p class="mb-0"><i class="bi bi-file-earmark-pdf me-2"></i> Importez des documents PDF pour analyse</p>
                    </div>
                </div>
            </div>
            
            <!-- Historique -->
            <div class="sidebar-card">
                <div class="sidebar-header">
                    <i class="bi bi-clock-history me-2"></i>
                    <span>Historique</span>
                </div>
                <div class="sidebar-content">
                    <p class="text-white-50 small">Vos conversations r√©centes :</p>
                    <div id="conversationHistory">
                        <p class="text-center text-white-50 small">Aucune conversation r√©cente</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal d'upload de PDF -->
<div class="custom-modal" id="pdfUploadModal">
    <div class="modal-content">
        <div class="modal-header">
            <div class="modal-title">Importer un document PDF</div>
            <button class="modal-close" id="closePdfModalBtn">&times;</button>
        </div>
        <div class="modal-body">
            <div class="pdf-upload-area" id="pdfDropArea">
                <i class="bi bi-file-earmark-pdf pdf-upload-icon"></i>
                <div class="pdf-upload-text">Glissez-d√©posez votre fichier PDF ici</div>
                <div class="pdf-upload-hint">ou cliquez pour s√©lectionner un fichier</div>
                <input type="file" class="pdf-upload-input" id="pdfFileInput" accept=".pdf">
            </div>
            <div class="d-grid">
                <button class="btn report-button" id="confirmPdfUploadBtn" disabled>
                    <i class="bi bi-upload me-2"></i> Importer et analyser
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // √âl√©ments DOM
        const chatMessages = document.getElementById('chatMessages');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const suggestionChips = document.querySelectorAll('.suggestion-chip');
        const clearChatBtn = document.getElementById('clearChatBtn');
        const exportChatBtn = document.getElementById('exportChatBtn');
        const voiceInputBtn = document.getElementById('voiceInputBtn');
        const uploadPdfBtn = document.getElementById('uploadPdfBtn');
        const agentOptions = document.querySelectorAll('.agent-option');
        
        // √âl√©ments pour l'enregistrement vocal
        const voiceRecordingContainer = document.getElementById('voiceRecordingContainer');
        const stopRecordingBtn = document.getElementById('stopRecordingBtn');
        const cancelRecordingBtn = document.getElementById('cancelRecordingBtn');
        const recordingTime = document.getElementById('recordingTime');
        
        // √âl√©ments pour l'upload de PDF
        const pdfUploadModal = document.getElementById('pdfUploadModal');
        const closePdfModalBtn = document.getElementById('closePdfModalBtn');
        const pdfDropArea = document.getElementById('pdfDropArea');
        const pdfFileInput = document.getElementById('pdfFileInput');
        const confirmPdfUploadBtn = document.getElementById('confirmPdfUploadBtn');
        const pdfPreviewContainer = document.getElementById('pdfPreviewContainer');
        const pdfFileName = document.getElementById('pdfFileName');
        const pdfFileSize = document.getElementById('pdfFileSize');
        const removePdfBtn = document.getElementById('removePdfBtn');
        
        // Variables globales
        let selectedAgent = 'llama4';
        let mediaRecorder = null;
        let recordedChunks = [];
        let recordingInterval = null;
        let recordingStartTime = 0;
        let currentPdfFile = null;
        
        // Fonction pour ajouter un message √† la conversation
        function addMessage(content, isUser = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user-message' : 'bot-message'}`;
            
            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';
            messageContent.innerHTML = content; // Utiliser innerHTML pour supporter le formatage
            
            const messageTime = document.createElement('div');
            messageTime.className = 'message-time';
            messageTime.textContent = 'Aujourd\'hui, ' + new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            messageDiv.appendChild(messageContent);
            messageDiv.appendChild(messageTime);
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // Fonction pour afficher l'indicateur de frappe
        function showTypingIndicator() {
            const typingDiv = document.createElement('div');
            typingDiv.className = 'typing-indicator';
            typingDiv.id = 'typingIndicator';
            
            typingDiv.innerHTML = `
                <span>Assistant est en train d'√©crire</span>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
            `;
            
            chatMessages.appendChild(typingDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // Fonction pour masquer l'indicateur de frappe
        function hideTypingIndicator() {
            const indicator = document.getElementById('typingIndicator');
            if (indicator) {
                indicator.remove();
            }
        }
        
        // Fonction pour envoyer un message
        async function sendMessage(message, withFile = null) {
            if (!message.trim() && !withFile) return;
            
            // Afficher le message de l'utilisateur
            addMessage(message, true);
            messageInput.value = '';
            
            // Ajuster la hauteur du textarea
            messageInput.style.height = 'auto';
            
            // Afficher l'indicateur de frappe
            showTypingIndicator();
            
            try {
                // Pr√©parer les donn√©es √† envoyer
                const formData = new FormData();
                formData.append('message', message);
                formData.append('agent', selectedAgent);
                
                // Ajouter le fichier PDF si pr√©sent
                if (withFile) {
                    formData.append('file', withFile);
                }
                
                // Envoyer la requ√™te √† l'API
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                // Masquer l'indicateur de frappe
                hideTypingIndicator();
                
                // Afficher la r√©ponse
                addMessage(data.text || 'D√©sol√©, je n\'ai pas pu traiter votre demande.');
                
                // Mettre √† jour l'historique des conversations
                updateConversationHistory(message, data.text);
                
                // Afficher les suggestions si disponibles
                if (data.suggestions && data.suggestions.length > 0) {
                    updateSuggestions(data.suggestions);
                }
                
            } catch (error) {
                console.error('Erreur:', error);
                hideTypingIndicator();
                addMessage('D√©sol√©, une erreur est survenue lors du traitement de votre demande.');
            }
        }
        
        // Fonction pour mettre √† jour les suggestions
        function updateSuggestions(suggestions) {
            const suggestionsDiv = document.querySelector('.suggestions');
            suggestionsDiv.innerHTML = '';
            
            suggestions.forEach(suggestion => {
                const chip = document.createElement('div');
                chip.className = 'suggestion-chip';
                chip.textContent = suggestion;
                chip.addEventListener('click', () => sendMessage(suggestion));
                suggestionsDiv.appendChild(chip);
            });
        }
        
        // Fonction pour mettre √† jour l'historique des conversations
        function updateConversationHistory(userMessage, botResponse) {
            const historyDiv = document.getElementById('conversationHistory');
            
            // Supprimer le message "Aucune conversation r√©cente"
            if (historyDiv.querySelector('p.text-center')) {
                historyDiv.innerHTML = '';
            }
            
            // Cr√©er un √©l√©ment pour cette conversation
            const conversationItem = document.createElement('div');
            conversationItem.className = 'mb-2 pb-2 border-bottom border-secondary';
            
            // Tronquer les messages longs
            const truncatedUserMessage = userMessage.length > 30 ? userMessage.substring(0, 30) + '...' : userMessage;
            
            conversationItem.innerHTML = `
                <div class="small text-white-50">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
                <div class="small text-truncate">${truncatedUserMessage}</div>
            `;
            
            // Ajouter un √©v√©nement pour restaurer cette conversation
            conversationItem.style.cursor = 'pointer';
            conversationItem.addEventListener('click', () => {
                // Ici, vous pourriez impl√©menter la restauration de la conversation compl√®te
                addMessage(userMessage, true);
                addMessage(botResponse);
            });
            
            // Ajouter √† l'historique (au d√©but)
            historyDiv.insertBefore(conversationItem, historyDiv.firstChild);
            
            // Limiter le nombre d'√©l√©ments dans l'historique
            const maxHistoryItems = 5;
            const historyItems = historyDiv.querySelectorAll('div.mb-2');
            if (historyItems.length > maxHistoryItems) {
                for (let i = maxHistoryItems; i < historyItems.length; i++) {
                    historyDiv.removeChild(historyItems[i]);
                }
            }
        }
        
        // Gestion de l'enregistrement vocal
        function startVoiceRecording() {
            // V√©rifier si l'API MediaRecorder est disponible
            if (!navigator.mediaDevices || !window.MediaRecorder) {
                alert('Votre navigateur ne prend pas en charge l\'enregistrement vocal.');
                return;
            }
            
            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(stream => {
                    // Afficher l'interface d'enregistrement
                    voiceRecordingContainer.style.display = 'flex';
                    
                    // Initialiser l'enregistreur
                    mediaRecorder = new MediaRecorder(stream);
                    recordedChunks = [];
                    
                    // √âv√©nement pour collecter les donn√©es
                    mediaRecorder.ondataavailable = (e) => {
                        if (e.data.size > 0) {
                            recordedChunks.push(e.data);
                        }
                    };
                    
                    // √âv√©nement de fin d'enregistrement
                    mediaRecorder.onstop = () => {
                        // Arr√™ter tous les tracks du stream pour lib√©rer le micro
                        stream.getTracks().forEach(track => track.stop());
                        
                        // Cr√©er un blob avec les donn√©es enregistr√©es
                        const audioBlob = new Blob(recordedChunks, { type: 'audio/webm' });
                        
                        // Ici, vous pourriez impl√©menter l'envoi de l'audio au serveur pour transcription
                        // Pour cet exemple, nous allons simuler une transcription
                        setTimeout(() => {
                            const transcription = "Voici ma question dict√©e par commande vocale.";
                            messageInput.value = transcription;
                            voiceRecordingContainer.style.display = 'none';
                            clearInterval(recordingInterval);
                        }, 1000);
                    };
                    
                    // D√©marrer l'enregistrement
                    mediaRecorder.start();
                    recordingStartTime = Date.now();
                    
                    // Mettre √† jour le compteur de temps
                    recordingInterval = setInterval(updateRecordingTime, 1000);
                })
                .catch(error => {
                    console.error('Erreur lors de l\'acc√®s au microphone:', error);
                    alert('Impossible d\'acc√©der au microphone. Veuillez v√©rifier les permissions.');
                });
        }
        
        // Fonction pour mettre √† jour le temps d'enregistrement
        function updateRecordingTime() {
            const elapsedSeconds = Math.floor((Date.now() - recordingStartTime) / 1000);
            const minutes = Math.floor(elapsedSeconds / 60).toString().padStart(2, '0');
            const seconds = (elapsedSeconds % 60).toString().padStart(2, '0');
            recordingTime.textContent = `${minutes}:${seconds}`;
        }
        
        // Fonction pour arr√™ter l'enregistrement vocal
        function stopVoiceRecording() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
                clearInterval(recordingInterval);
            }
        }
        
        // Fonction pour annuler l'enregistrement vocal
        function cancelVoiceRecording() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
                clearInterval(recordingInterval);
                voiceRecordingContainer.style.display = 'none';
            }
        }
        
        // Gestion de l'upload de PDF
        function showPdfUploadModal() {
            pdfUploadModal.classList.add('show');
        }
        
        function hidePdfUploadModal() {
            pdfUploadModal.classList.remove('show');
        }
        
        function handlePdfFileSelect(file) {
            if (file && file.type === 'application/pdf') {
                currentPdfFile = file;
                
                // Mettre √† jour l'interface
                pdfFileName.textContent = file.name;
                pdfFileSize.textContent = formatFileSize(file.size);
                confirmPdfUploadBtn.disabled = false;
                
                // Pr√©visualisation (optionnelle)
                // Vous pourriez ajouter ici un aper√ßu du PDF si n√©cessaire
            } else {
                alert('Veuillez s√©lectionner un fichier PDF valide.');
                currentPdfFile = null;
                confirmPdfUploadBtn.disabled = true;
            }
        }
        
        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            else if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
            else return (bytes / 1048576).toFixed(1) + ' MB';
        }
        
        function confirmPdfUpload() {
            if (currentPdfFile) {
                hidePdfUploadModal();
                
                // Afficher l'aper√ßu du PDF dans l'interface de chat
                pdfPreviewContainer.style.display = 'block';
                
                // Envoyer le fichier au serveur avec un message
                sendMessage(`J'ai import√© le document "${currentPdfFile.name}". Pouvez-vous l'analyser ?`, currentPdfFile);
            }
        }
        
        function removePdfPreview() {
            pdfPreviewContainer.style.display = 'none';
            currentPdfFile = null;
        }
        
        // √âv√©nements pour l'enregistrement vocal
        voiceInputBtn.addEventListener('click', startVoiceRecording);
        stopRecordingBtn.addEventListener('click', stopVoiceRecording);
        cancelRecordingBtn.addEventListener('click', cancelVoiceRecording);
        
        // √âv√©nements pour l'upload de PDF
        uploadPdfBtn.addEventListener('click', showPdfUploadModal);
        closePdfModalBtn.addEventListener('click', hidePdfUploadModal);
        removePdfBtn.addEventListener('click', removePdfPreview);
        
        // Configuration du drag & drop pour les PDF
        pdfDropArea.addEventListener('click', () => pdfFileInput.click());
        
        pdfFileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handlePdfFileSelect(e.target.files[0]);
            }
        });
        
        pdfDropArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            pdfDropArea.style.borderColor = 'rgba(205, 133, 63, 0.8)';
            pdfDropArea.style.background = 'rgba(205, 133, 63, 0.1)';
        });
        
        pdfDropArea.addEventListener('dragleave', () => {
            pdfDropArea.style.borderColor = 'rgba(205, 133, 63, 0.5)';
            pdfDropArea.style.background = 'transparent';
        });
        
        pdfDropArea.addEventListener('drop', (e) => {
            e.preventDefault();
            pdfDropArea.style.borderColor = 'rgba(205, 133, 63, 0.5)';
            pdfDropArea.style.background = 'transparent';
            
            if (e.dataTransfer.files.length > 0) {
                handlePdfFileSelect(e.dataTransfer.files[0]);
            }
        });
        
        confirmPdfUploadBtn.addEventListener('click', confirmPdfUpload);
        
        // Gestion de la s√©lection d'agent
        agentOptions.forEach(option => {
            option.addEventListener('click', function() {
                // Supprimer la classe active de toutes les options
                agentOptions.forEach(opt => opt.classList.remove('active'));
                
                // Ajouter la classe active √† l'option s√©lectionn√©e
                this.classList.add('active');
                
                // Mettre √† jour l'agent s√©lectionn√©
                selectedAgent = this.dataset.agent;
                
                // Informer l'utilisateur du changement
                addMessage(`J'ai chang√© d'agent pour utiliser <strong>${this.querySelector('.agent-option-title').textContent}</strong>. Comment puis-je vous aider ?`);
            });
        });
        
        // √âv√©nement pour envoyer un message
        sendButton.addEventListener('click', () => {
            sendMessage(messageInput.value);
        });
        
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage(messageInput.value);
            }
        });
        
        // Ajuster automatiquement la hauteur du textarea
        messageInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
        });
        
        // √âv√©nements pour les suggestions
        suggestionChips.forEach(chip => {
            chip.addEventListener('click', () => {
                sendMessage(chip.textContent);
            });
        });
        
        // √âv√©nement pour effacer la conversation
        clearChatBtn.addEventListener('click', () => {
            if (confirm('√ätes-vous s√ªr de vouloir effacer toute la conversation ?')) {
                // Supprimer tous les messages sauf le message de bienvenue
                const welcomeMessage = chatMessages.firstElementChild;
                chatMessages.innerHTML = '';
                chatMessages.appendChild(welcomeMessage);
            }
        });
        
        // √âv√©nement pour exporter la conversation
        exportChatBtn.addEventListener('click', () => {
            const messages = chatMessages.querySelectorAll('.message');
            let conversationText = 'Conversation avec l\'Assistant R√©glementaire\n\n';
            
            messages.forEach(message => {
                const isUser = message.classList.contains('user-message');
                const content = message.querySelector('.message-content').textContent;
                const time = message.querySelector('.message-time').textContent;
                
                conversationText += `[${time}] ${isUser ? 'Vous' : 'Assistant'}: ${content}\n\n`;
            });
            
            // Cr√©er un blob et un lien de t√©l√©chargement
            const blob = new Blob([conversationText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `conversation-${new Date().toISOString().slice(0, 10)}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });
        
        // Initialiser l'interface
        messageInput.focus();
    });
</script>
{% endblock %}