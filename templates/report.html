{% extends "base.html" %}

{% block title %}Génération de Rapport{% endblock %}

{% block head %}
<style>
    .report-container {
        background: linear-gradient(135deg, rgba(50, 30, 0, 0.8), rgba(60, 30, 10, 0.8));
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        border: 1px solid rgba(205, 133, 63, 0.3);
        margin-bottom: 20px;
    }
    
    .report-form-section {
        background: rgba(0, 0, 0, 0.2);
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
    }
    
    .report-section-title {
        font-size: 1.2rem;
        font-weight: 600;
        margin-bottom: 15px;
        color: rgba(205, 133, 63, 0.9);
    }
    
    .report-input {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(205, 133, 63, 0.3);
        border-radius: 10px;
        padding: 12px 15px;
        color: white;
    }
    
    .report-input::placeholder {
        color: rgba(255, 255, 255, 0.5);
    }
    
    .report-button {
        background: rgba(205, 133, 63, 0.8);
        border: none;
        border-radius: 30px;
        padding: 12px 25px;
        color: white;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    
    .report-button:hover {
        background: rgba(205, 133, 63, 1);
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    }
    
    .report-preview {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 10px;
        padding: 20px;
        margin-top: 20px;
    }
    
    .report-preview-title {
        font-size: 1.5rem;
        font-weight: 600;
        margin-bottom: 15px;
        color: rgba(205, 133, 63, 0.9);
        border-bottom: 1px solid rgba(205, 133, 63, 0.3);
        padding-bottom: 10px;
    }
    
    .report-preview-section {
        margin-bottom: 20px;
    }
    
    .report-preview-section-title {
        font-size: 1.2rem;
        font-weight: 600;
        margin-bottom: 10px;
        color: rgba(205, 133, 63, 0.8);
    }
    
    .report-preview-content {
        line-height: 1.6;
    }
    
    .report-format-option {
        display: inline-block;
        background: rgba(0, 0, 0, 0.2);
        border: 1px solid rgba(205, 133, 63, 0.3);
        border-radius: 5px;
        padding: 8px 15px;
        margin-right: 10px;
        margin-bottom: 10px;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .report-format-option:hover, .report-format-option.active {
        background: rgba(205, 133, 63, 0.3);
        border-color: rgba(205, 133, 63, 0.6);
    }
    
    .report-format-option i {
        margin-right: 5px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="display-5 mb-4">Génération de Rapport</h1>
            <p class="lead">Créez un rapport personnalisé sur la réglementation de la pêche en fonction de vos besoins.</p>
        </div>
    </div>
    
    <div class="row">
        <div class="col-lg-5 mb-4">
            <div class="report-container">
                <form id="reportForm" action="/api/generate-report" method="POST">
                    <div class="report-form-section">
                        <div class="report-section-title">Type de rapport</div>
                        <select class="form-select report-input mb-3" id="reportType" name="report_type" required>
                            <option value="" selected disabled>Sélectionnez un type de rapport</option>
                            <option value="species">Réglementation par espèce</option>
                            <option value="zone">Réglementation par zone</option>
                            <option value="gear">Réglementation par engin de pêche</option>
                            <option value="calendar">Calendrier de pêche</option>
                            <option value="complete">Rapport complet</option>
                        </select>
                    </div>
                    
                    <div class="report-form-section" id="speciesSection" style="display: none;">
                        <div class="report-section-title">Espèce concernée</div>
                        <input type="text" class="form-control report-input mb-3" id="speciesInput" name="species" placeholder="Ex: bar, thon, dorade...">
                    </div>
                    
                    <div class="report-form-section" id="zoneSection" style="display: none;">
                        <div class="report-section-title">Zone de pêche</div>
                        <select class="form-select report-input mb-3" id="zoneInput" name="zone">
                            <option value="" selected disabled>Sélectionnez une zone</option>
                            <option value="mediterranee">Méditerranée</option>
                            <option value="atlantique">Atlantique</option>
                            <option value="eau_douce">Eau douce</option>
                            <option value="golfe_gabes">Golfe de Gabès</option>
                            <option value="nord_tunisie">Nord de la Tunisie</option>
                        </select>
                    </div>
                    
                    <div class="report-form-section" id="gearSection" style="display: none;">
                        <div class="report-section-title">Engin de pêche</div>
                        <select class="form-select report-input mb-3" id="gearInput" name="gear">
                            <option value="" selected disabled>Sélectionnez un engin</option>
                            <option value="filet">Filet</option>
                            <option value="palangre">Palangre</option>
                            <option value="canne">Canne à pêche</option>
                            <option value="chalut">Chalut</option>
                            <option value="nasse">Nasse</option>
                        </select>
                    </div>
                    
                    <div class="report-form-section" id="calendarSection" style="display: none;">
                        <div class="report-section-title">Période</div>
                        <div class="row">
                            <div class="col-6">
                                <label class="form-label">Date de début</label>
                                <input type="date" class="form-control report-input mb-3" id="startDateInput" name="start_date">
                            </div>
                            <div class="col-6">
                                <label class="form-label">Date de fin</label>
                                <input type="date" class="form-control report-input mb-3" id="endDateInput" name="end_date">
                            </div>
                        </div>
                    </div>
                    
                    <div class="report-form-section">
                        <div class="report-section-title">Options du rapport</div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="includeImages" name="include_images" checked>
                            <label class="form-check-label" for="includeImages">Inclure des images</label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="includeMaps" name="include_maps" checked>
                            <label class="form-check-label" for="includeMaps">Inclure des cartes</label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="includeReferences" name="include_references" checked>
                            <label class="form-check-label" for="includeReferences">Inclure les références légales</label>
                        </div>
                    </div>
                    
                    <div class="d-grid mt-4">
                        <button type="submit" class="btn report-button" id="generateButton">
                            <i class="bi bi-file-earmark-text me-2"></i> Générer le rapport
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <div class="col-lg-7">
            <div class="report-container">
                <div id="reportPreview">
                    <div class="text-center py-5">
                        <i class="bi bi-file-earmark-text" style="font-size: 3rem; color: rgba(205, 133, 63, 0.5);"></i>
                        <p class="mt-3">Configurez les paramètres et générez un rapport pour voir l'aperçu</p>
                    </div>
                </div>
                
                <div id="reportActions" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center mt-4">
                        <div>
                            <div class="report-section-title">Format d'export</div>
                            <div>
                                <span class="report-format-option active" data-format="pdf">
                                    <i class="bi bi-file-earmark-pdf"></i> PDF
                                </span>
                                <span class="report-format-option" data-format="docx">
                                    <i class="bi bi-file-earmark-word"></i> Word
                                </span>
                                <span class="report-format-option" data-format="html">
                                    <i class="bi bi-file-earmark-code"></i> HTML
                                </span>
                            </div>
                        </div>
                        
                        <button class="btn report-button" id="downloadButton">
                            <i class="bi bi-download me-2"></i> Télécharger
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Gérer l'affichage des sections en fonction du type de rapport
        const reportType = document.getElementById('reportType');
        const speciesSection = document.getElementById('speciesSection');
        const zoneSection = document.getElementById('zoneSection');
        const gearSection = document.getElementById('gearSection');
        const calendarSection = document.getElementById('calendarSection');
        
        reportType.addEventListener('change', function() {
            // Masquer toutes les sections
            speciesSection.style.display = 'none';
            zoneSection.style.display = 'none';
            gearSection.style.display = 'none';
            calendarSection.style.display = 'none';
            
            // Afficher les sections pertinentes en fonction du type de rapport
            switch(this.value) {
                case 'species':
                    speciesSection.style.display = 'block';
                    break;
                case 'zone':
                    zoneSection.style.display = 'block';
                    break;
                case 'gear':
                    gearSection.style.display = 'block';
                    break;
                case 'calendar':
                    calendarSection.style.display = 'block';
                    speciesSection.style.display = 'block';
                    zoneSection.style.display = 'block';
                    break;
                case 'complete':
                    speciesSection.style.display = 'block';
                    zoneSection.style.display = 'block';
                    gearSection.style.display = 'block';
                    calendarSection.style.display = 'block';
                    break;
            }
        });
        
        // Gérer la soumission du formulaire de rapport
        const reportForm = document.getElementById('reportForm');
        const reportPreview = document.getElementById('reportPreview');
        const reportActions = document.getElementById('reportActions');
        
        reportForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Récupérer les valeurs du formulaire
            const formData = new FormData(reportForm);
            
            // Convertir les données du formulaire en objet JSON
            const parameters = {};
            for (const [key, value] of formData.entries()) {
                if (value) parameters[key] = value;
            }
            
            // Afficher un indicateur de chargement
            reportPreview.innerHTML = `
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Chargement...</span>
                    </div>
                    <p class="mt-3">Génération du rapport en cours...</p>
                </div>
            `;
            
            // Effectuer la requête API
            fetch('/api/generate-report', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams({
                    'report_type': formData.get('report_type'),
                    'parameters': JSON.stringify(parameters)
                })
            })
            .then(response => response.json())
            .then(data => {
                // Afficher l'aperçu du rapport
                displayReportPreview(data);
                // Afficher les actions de rapport
                reportActions.style.display = 'block';
            })
            .catch(error => {
                console.error('Erreur lors de la génération du rapport:', error);
                reportPreview.innerHTML = `
                    <div class="text-center py-5">
                        <i class="bi bi-exclamation-triangle" style="font-size: 2rem; color: #dc3545;"></i>
                        <p class="mt-3">Une erreur s'est produite lors de la génération du rapport. Veuillez réessayer.</p>
                    </div>
                `;
                reportActions.style.display = 'none';
            });
        });
        
        // Gérer les options de format
        const formatOptions = document.querySelectorAll('.report-format-option');
        formatOptions.forEach(option => {
            option.addEventListener('click', function() {
                // Supprimer la classe active de toutes les options
                formatOptions.forEach(opt => opt.classList.remove('active'));
                // Ajouter la classe active à l'option sélectionnée
                this.classList.add('active');
            });
        });
        
        // Gérer le bouton de téléchargement
        const downloadButton = document.getElementById('downloadButton');
        downloadButton.addEventListener('click', function() {
            // Récupérer le format sélectionné
            const selectedFormat = document.querySelector('.report-format-option.active').dataset.format;
            
            // Récupérer les valeurs du formulaire
            const formData = new FormData(reportForm);
            
            // Convertir les données du formulaire en objet JSON
            const parameters = {};
            for (const [key, value] of formData.entries()) {
                if (value) parameters[key] = value;
            }
            parameters.format = selectedFormat;
            
            // Construire l'URL de téléchargement
            const downloadUrl = `/api/download-report?report_type=${formData.get('report_type')}&parameters=${encodeURIComponent(JSON.stringify(parameters))}`;
            
            // Ouvrir l'URL dans un nouvel onglet
            window.open(downloadUrl, '_blank');
        });
        
        // Fonction pour afficher l'aperçu du rapport
        function displayReportPreview(data) {
            if (!data || !data.title) {
                reportPreview.innerHTML = `
                    <div class="text-center py-5">
                        <i class="bi bi-exclamation-triangle" style="font-size: 2rem; color: #dc3545;"></i>
                        <p class="mt-3">Impossible de générer l'aperçu du rapport.</p>
                    </div>
                `;
                return;
            }
            
            let sectionsHTML = '';
            
            // Générer le HTML pour chaque section
            data.sections.forEach(section => {
                sectionsHTML += `
                    <div class="report-preview-section">
                        <div class="report-preview-section-title">${section.title}</div>
                        <div class="report-preview-content">${section.content}</div>
                    </div>
                `;
            });
            
            // Afficher l'aperçu complet
            reportPreview.innerHTML = `
                <div class="report-preview">
                    <div class="report-preview-title">${data.title}</div>
                    <p class="mb-4">${data.summary}</p>
                    ${sectionsHTML}
                </div>
            `;
        }
    });
</script>
{% endblock %}