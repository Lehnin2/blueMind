{% extends "base.html" %}

{% block title %}D√©tection AR des Poissons{% endblock %}

{% block content %}
<div class="container mt-5">
    <h1 class="text-center mb-4">üêü D√©tection AR des Poissons</h1>
    
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card mb-4">
                <div class="card-body">
                    <ul class="nav nav-tabs" id="myTab" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="ar-tab" data-bs-toggle="tab" data-bs-target="#ar" type="button" role="tab">
                                <i class="fas fa-mobile-alt me-1"></i> Mode AR
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="info-tab" data-bs-toggle="tab" data-bs-target="#info" type="button" role="tab">
                                <i class="fas fa-info-circle me-1"></i> Informations
                            </button>
                        </li>
                    </ul>
                </div>
            </div>

            <div class="tab-content" id="myTabContent">
                <!-- Tab AR -->
                <div class="tab-pane fade show active" id="ar" role="tabpanel">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">D√©tection en Temps R√©el avec AR</h5>
                            <div class="text-center">
                                <div class="position-relative">
                                    <video id="webcam" autoplay playsinline style="max-width: 100%; border-radius: 10px;"></video>
                                    <canvas id="overlay" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;"></canvas>
                                </div>
                                <div class="mt-3">
                                    <button id="startWebcam" class="btn btn-primary me-2">
                                        <i class="fas fa-play me-1"></i> D√©marrer
                                    </button>
                                    <button id="stopWebcam" class="btn btn-danger" style="display: none;">
                                        <i class="fas fa-stop me-1"></i> Arr√™ter
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tab Info -->
                <div class="tab-pane fade" id="info" role="tabpanel">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Comment utiliser la d√©tection AR</h5>
                            <div class="alert alert-info">
                                <h6><i class="fas fa-lightbulb me-2"></i>Instructions :</h6>
                                <ol>
                                    <li>Cliquez sur "D√©marrer" pour activer la cam√©ra</li>
                                    <li>Pointez la cam√©ra vers un poisson</li>
                                    <li>Attendez que le syst√®me d√©tecte le poisson</li>
                                    <li>Les informations appara√Ætront en superposition</li>
                                </ol>
                            </div>
                            <div class="alert alert-warning">
                                <h6><i class="fas fa-exclamation-triangle me-2"></i>Conseils :</h6>
                                <ul>
                                    <li>Assurez-vous d'avoir une bonne luminosit√©</li>
                                    <li>Maintenez la cam√©ra stable</li>
                                    <li>Approchez-vous suffisamment du poisson</li>
                                    <li>√âvitez les reflets sur l'eau</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Loading Indicator -->
            <div id="loading" class="text-center mt-4" style="display: none;">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Chargement...</span>
                </div>
                <p class="mt-2">Analyse en cours...</p>
            </div>

            <!-- R√©sultats -->
            <div id="result" class="mt-4" style="display: none;">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Informations sur le poisson</h5>
                        <div id="arResults"></div>
                    </div>
                </div>
            </div>

            <div id="error" class="alert alert-danger mt-4" style="display: none;">
                <i class="fas fa-exclamation-circle me-2"></i>
                <span id="errorMessage"></span>
            </div>
        </div>
    </div>
</div>

<script>
// Gestion de la webcam
let videoStream = null;
let isAnalyzing = false;
let lastAnalysisTime = 0;
const ANALYSIS_INTERVAL = 1000; // 1 seconde entre chaque analyse

document.getElementById('startWebcam').addEventListener('click', startWebcam);
document.getElementById('stopWebcam').addEventListener('click', stopWebcam);

async function startWebcam() {
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ 
            video: { 
                width: { ideal: 640 },
                height: { ideal: 480 },
                facingMode: "environment"
            } 
        });
        const video = document.getElementById('webcam');
        video.srcObject = stream;
        videoStream = stream;
        document.getElementById('startWebcam').style.display = 'none';
        document.getElementById('stopWebcam').style.display = 'inline-block';
        isAnalyzing = true;
        
        // D√©marrer l'analyse apr√®s que la vid√©o soit pr√™te
        video.onloadedmetadata = () => {
            analyzeWebcam();
        };
    } catch (error) {
        showError('Erreur lors de l\'acc√®s √† la webcam: ' + error.message);
    }
}

function stopWebcam() {
    if (videoStream) {
        videoStream.getTracks().forEach(track => track.stop());
        videoStream = null;
    }
    document.getElementById('startWebcam').style.display = 'inline-block';
    document.getElementById('stopWebcam').style.display = 'none';
    isAnalyzing = false;
}

async function analyzeWebcam() {
    if (!isAnalyzing) return;

    const video = document.getElementById('webcam');
    const overlay = document.getElementById('overlay');
    const ctx = overlay.getContext('2d');
    
    // Ajuster la taille du canvas overlay
    overlay.width = video.videoWidth;
    overlay.height = video.videoHeight;
    
    try {
        // Cr√©er un canvas temporaire pour la capture
        const canvas = document.createElement('canvas');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        const captureCtx = canvas.getContext('2d');
        
        // Capturer l'image
        captureCtx.drawImage(video, 0, 0, canvas.width, canvas.height);
        
        // Convertir en blob
        const blob = await new Promise(resolve => {
            canvas.toBlob(resolve, 'image/jpeg', 0.8);
        });
        
        const formData = new FormData();
        formData.append('file', blob, 'frame.jpg');
        
        // Envoyer l'image pour analyse
        const response = await fetch('/detection/detect-ar', {
            method: 'POST',
            body: formData
        });
        
        if (response.ok) {
            const result = await response.json();
            
            // Effacer le canvas overlay
            ctx.clearRect(0, 0, overlay.width, overlay.height);
            
            // Dessiner les bounding boxes
            if (result.detections && result.detections.length > 0) {
                result.detections.forEach(detection => {
                    const [x1, y1, x2, y2] = detection.bbox;
                    
                    // Dessiner le rectangle
                    ctx.strokeStyle = detection.class === 'poisonous' || detection.class === 'venomous' 
                        ? '#ff0000' 
                        : '#00ff00';
                    ctx.lineWidth = 2;
                    ctx.strokeRect(x1, y1, x2 - x1, y2 - y1);
                    
                    // Dessiner le texte
                    const text = `${detection.class.toUpperCase()} ${(detection.confidence * 100).toFixed(1)}%`;
                    ctx.fillStyle = '#000000';
                    ctx.font = '14px Arial';
                    const textWidth = ctx.measureText(text).width;
                    ctx.fillRect(x1, y1 - 20, textWidth + 10, 20);
                    ctx.fillStyle = '#ffffff';
                    ctx.fillText(text, x1 + 5, y1 - 5);
                });
            }
        }
    } catch (error) {
        console.error('Erreur lors de l\'analyse:', error);
    }
    
    // Continuer l'analyse
    requestAnimationFrame(analyzeWebcam);
}

function resetDisplay() {
    document.getElementById('result').style.display = 'none';
    document.getElementById('error').style.display = 'none';
}

function showError(message) {
    const errorDiv = document.getElementById('error');
    const errorMessage = document.getElementById('errorMessage');
    errorMessage.textContent = message;
    errorDiv.style.display = 'block';
}
</script>
{% endblock %} 