<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rapport d'Espèces Marines - AquaSense</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #1a4b84;
            --secondary-color: #2d7dd2;
            --accent-color: #45b3e7;
            --deep-sea: #053B50;
            --sea-blue: #176B87;
            --aqua: #64CCC5;
        }
        
        .marine-theme {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
        }

        .navbar {
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .marine-card {
            background: rgba(255, 255, 255, 0.95);
            border: none;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            overflow: hidden;
        }

        .marine-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        }

        .card-title {
            color: var(--primary-color);
            font-weight: 600;
        }

        .btn-primary {
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
            border: none;
            border-radius: 25px;
            padding: 10px 25px;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            transform: scale(1.05);
            background: linear-gradient(to right, var(--secondary-color), var(--accent-color));
        }

        .feature-icon {
            font-size: 2.5rem;
            margin-bottom: 1rem;
            color: var(--primary-color);
        }

        .loading {
            display: inline-block;
            width: 50px;
            height: 50px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: var(--aqua);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .tab-active {
            border-bottom: 3px solid var(--aqua);
            background: rgba(255, 255, 255, 0.1);
        }

        .report-container {
            max-height: 70vh;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: var(--aqua) rgba(255, 255, 255, 0.1);
        }

        .report-container::-webkit-scrollbar {
            width: 6px;
        }

        .report-container::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }

        .report-container::-webkit-scrollbar-thumb {
            background-color: var(--aqua);
            border-radius: 10px;
        }

        .fish-card {
            transition: all 0.3s ease;
        }

        .fish-card:hover {
            transform: translateY(-5px);
        }

        .wave-divider {
            height: 50px;
            background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1440 320'%3E%3Cpath fill='%2364CCC5' fill-opacity='0.5' d='M0,192L48,197.3C96,203,192,213,288,229.3C384,245,480,267,576,250.7C672,235,768,181,864,181.3C960,181,1056,235,1152,234.7C1248,235,1344,181,1392,154.7L1440,128L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z'%3E%3C/path%3E%3C/svg%3E");
            background-size: cover;
            background-repeat: no-repeat;
            margin: 20px 0;
        }

        .nav-link {
            position: relative;
            padding: 0.5rem 1rem;
        }

        .nav-link::after {
            content: '';
            position: absolute;
            width: 0;
            height: 2px;
            bottom: 0;
            left: 50%;
            background-color: white;
            transition: all 0.3s ease;
        }

        .nav-link:hover::after {
            width: 80%;
            left: 10%;
        }

        .search-box {
            position: relative;
        }

        .search-box i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--secondary-color);
        }

        .search-input {
            padding-left: 45px;
            border-radius: 25px;
            border: 2px solid var(--aqua);
        }

        .species-image {
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            max-height: 400px;
            object-fit: cover;
        }
    </style>
</head>
<body class="marine-theme d-flex flex-column min-vh-100">
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand d-flex align-items-center" href="/">
                <i class="fas fa-fish me-2"></i>
                AquaSense
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/"><i class="fas fa-home me-1"></i> Accueil</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/meteo"><i class="fas fa-cloud-sun me-1"></i> Météo</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/chatbot"><i class="fas fa-robot me-1"></i> Assistant</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/rapport"><i class="fas fa-file-alt me-1"></i> Rapports</a>
                    </li>
                </ul>
                <div class="d-flex align-items-center">
                    <a href="/profile" class="btn btn-outline-light me-2">
                        <i class="fas fa-user me-1"></i> Mon Profil
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <div class="container my-5 flex-grow-1">
        <div class="marine-card p-4 mb-4">
            <h1 class="text-center mb-4">
                <i class="fas fa-fish me-2"></i>Explorateur Marin Tunisien
            </h1>
            <p class="text-center lead mb-0">Découvrez les espèces marines de la côte tunisienne</p>
        </div>

        <div class="marine-card p-0 overflow-hidden">
            <!-- Onglets -->
            <ul class="nav nav-tabs" id="speciesTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="generator-tab" data-bs-toggle="tab" data-bs-target="#generator" type="button" role="tab">
                        <i class="fas fa-fish me-2"></i>Explorer les Espèces
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="fishing-tab" data-bs-toggle="tab" data-bs-target="#fishing" type="button" role="tab">
                        <i class="fas fa-anchor me-2"></i>Guide de Pêche Durable
                    </button>
                </li>
            </ul>

            <!-- Contenu des onglets -->
            <div class="tab-content p-4">
                <!-- Générateur d'images -->
                <div class="tab-pane fade show active" id="generator" role="tabpanel">
                    <form id="image-form" class="mb-4">
                        <div class="row g-3">
                            <div class="col-md-9">
                                <div class="search-box">
                                    <i class="fas fa-search"></i>
                                    <input type="text" id="prompt" name="prompt" 
                                           class="form-control search-input" 
                                           placeholder="Recherchez une espèce marine (ex: sardine, mérou, daurade)...">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <button type="submit" class="btn btn-primary w-100">
                                    <i class="fas fa-search-location me-2"></i>Découvrir
                                </button>
                            </div>
                        </div>
                    </form>

                    <div id="loading" class="text-center my-5 py-5 d-none">
                        <div class="loading"></div>
                        <p class="mt-3 text-muted">Exploration en cours...</p>
                    </div>

                    <div id="result" class="d-none fade-in">
                        <div class="marine-card p-4">
                            <h2 class="mb-4">
                                <i class="fas fa-file-alt me-2"></i>Fiche d'Espèce
                            </h2>
                            
                            <div class="row">
                                <div class="col-md-5">
                                    <div class="text-center mb-4">
                                        <img id="generated-image" class="species-image w-100" alt="Image de l'espèce">
                                    </div>
                                    
                                    <div class="marine-card p-3 mb-4">
                                        <h4 class="mb-3">
                                            <i class="fas fa-info-circle me-2"></i>Statut de conservation
                                        </h4>
                                        <div id="conservation-status" class="text-muted">
                                            Les informations sur le statut de conservation seront générées en fonction de l'espèce recherchée.
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-7">
                                    <div id="text-result" class="mb-4"></div>
                                    
                                    <div class="marine-card p-3 mb-4">
                                        <h4 class="mb-3">
                                            <i class="fas fa-map-marker-alt me-2"></i>Habitat en Tunisie
                                        </h4>
                                        <div id="habitat-info" class="text-muted">
                                            Les informations spécifiques sur l'habitat en Tunisie seront générées en fonction de l'espèce recherchée.
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="wave-divider"></div>
                            
                            <div class="mt-4">
                                <h4 class="mb-3">
                                    <i class="fas fa-fish me-2"></i>Pêche durable
                                </h4>
                                <div id="fishing-recommendations" class="text-muted">
                                    Les recommandations pour une pêche durable seront générées en fonction de l'espèce recherchée.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Conseils de pêche -->
                <div class="tab-pane fade" id="fishing" role="tabpanel">
                    <div id="fishing-loading" class="text-center my-5 py-5">
                        <div class="loading"></div>
                        <p class="mt-3 text-muted">Chargement des conseils...</p>
                    </div>
                    
                    <div id="fishing-content" class="d-none fade-in">
                        <div id="fishing-text" class="marine-card p-4 mb-4"></div>
                        
                        <div class="marine-card p-4 mb-4">
                            <h4 class="mb-4">
                                <i class="fas fa-camera me-2"></i>Galerie
                            </h4>
                            <div id="fishing-images" class="row g-4">
                                <!-- Images de pêche générées dynamiquement -->
                            </div>
                        </div>
                        
                        <div class="marine-card p-4">
                            <h4 class="mb-4">
                                <i class="fas fa-calendar-alt me-2"></i>Calendrier de Pêche
                            </h4>
                            <p class="text-muted mb-4">Périodes optimales pour la pêche en Tunisie selon les espèces:</p>
                            
                            <div class="row g-4">
                                <div class="col-md-4">
                                    <div class="fish-card marine-card p-3">
                                        <h5 class="text-primary">Printemps (Mars-Mai)</h5>
                                        <ul class="mt-2 text-muted">
                                            <li class="mb-1">• Daurade royale</li>
                                            <li class="mb-1">• Loup (Bar)</li>
                                            <li>• Mulet</li>
                                        </ul>
                                    </div>
                                </div>
                                
                                <div class="col-md-4">
                                    <div class="fish-card marine-card p-3">
                                        <h5 class="text-primary">Été (Juin-Août)</h5>
                                        <ul class="mt-2 text-muted">
                                            <li class="mb-1">• Thon</li>
                                            <li class="mb-1">• Bonite</li>
                                            <li>• Mérou</li>
                                        </ul>
                                    </div>
                                </div>
                                
                                <div class="col-md-4">
                                    <div class="fish-card marine-card p-3">
                                        <h5 class="text-primary">Automne (Sept-Nov)</h5>
                                        <ul class="mt-2 text-muted">
                                            <li class="mb-1">• Pageot</li>
                                            <li class="mb-1">• Denté</li>
                                            <li>• Sériole</li>
                                        </ul>
                                    </div>
                                </div>
                                
                                <div class="col-md-4">
                                    <div class="fish-card marine-card p-3">
                                        <h5 class="text-primary">Hiver (Déc-Fév)</h5>
                                        <ul class="mt-2 text-muted">
                                            <li class="mb-1">• Dorade grise</li>
                                            <li class="mb-1">• Sar</li>
                                            <li>• Rouget</li>
                                        </ul>
                                    </div>
                                </div>
                                
                                <div class="col-md-4">
                                    <div class="fish-card marine-card p-3">
                                        <h5 class="text-primary">Toute l'année</h5>
                                        <ul class="mt-2 text-muted">
                                            <li class="mb-1">• Sardine</li>
                                            <li class="mb-1">• Anchois</li>
                                            <li>• Maquereau</li>
                                        </ul>
                                    </div>
                                </div>
                                
                                <div class="col-md-4">
                                    <div class="fish-card marine-card p-3">
                                        <h5 class="text-danger">Périodes d'interdiction</h5>
                                        <ul class="mt-2 text-muted">
                                            <li class="mb-1">• Poulpe (Juin-Oct)</li>
                                            <li class="mb-1">• Mérou (période de frai)</li>
                                            <li>• Vérifiez la réglementation</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer class="footer py-4 mt-auto">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-6 text-center text-md-start">
                    <span class="text-white">© 2024 Blue Mind - Tous droits réservés</span>
                </div>
                <div class="col-md-6 text-center text-md-end">
                    <a href="#" class="text-white me-3"><i class="fab fa-facebook"></i></a>
                    <a href="#" class="text-white me-3"><i class="fab fa-twitter"></i></a>
                    <a href="#" class="text-white"><i class="fab fa-instagram"></i></a>
                </div>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Gestion des onglets avec Bootstrap
        const tabElms = document.querySelectorAll('button[data-bs-toggle="tab"]');
        tabElms.forEach(tabEl => {
            tabEl.addEventListener('shown.bs.tab', function (event) {
                if (event.target.id === 'fishing-tab') {
                    loadFishingTips();
                }
            });
        });

        // Formatter le contenu du rapport
        function formatReport(text) {
            // Extraire le nom scientifique
            const scientificNameMatch = text.match(/\([^)]*\*([^*]+)\*[^)]*\)/);
            const scientificName = scientificNameMatch ? scientificNameMatch[1].trim() : '';
            
            // Extraire les sections du rapport
            const parts = text.split('**');
            let formattedHTML = '';
            
            // Créer un en-tête structuré
            if (text.includes('Rapport sur')) {
                const titleMatch = text.match(/Rapport sur (la|le|l'|les) ([^(]+)/);
                if (titleMatch) {
                    const speciesName = titleMatch[2].trim();
                    formattedHTML += `<h3 class="mb-4">${speciesName}</h3>`;
                    
                    if (scientificName) {
                        formattedHTML += `<p class="text-muted mb-4"><em>${scientificName}</em></p>`;
                    }
                }
            }
            
            // Convertir le markdown en HTML structuré
            let content = text;
            
            // Remplacer les titres
            content = content.replace(/##\s+(.*)/g, '<h4 class="mt-4 mb-3">$1</h4>');
            content = content.replace(/###\s+(.*)/g, '<h5 class="mt-3 mb-2">$1</h5>');
            
            // Remplacer les listes
            content = content.replace(/\*\s+(.*)/g, '<li class="mb-1">• $1</li>');
            content = content.replace(/<li/g, '<ul class="mb-3"><li');
            content = content.replace(/<\/li>\s*(?!<li)/g, '</li></ul>');
            
            // Remplacer le gras
            content = content.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
            
            // Remplacer l'italique
            content = content.replace(/\*([^*]+)\*/g, '<em>$1</em>');
            
            // Créer des sections bien définies
            const sections = [
                'Caractéristiques physiques',
                'Habitat et mode de vie',
                'Reproduction',
                'Alimentation',
                'Importance écologique',
                'Importance économique'
            ];
            
            sections.forEach(section => {
                const regex = new RegExp(`<strong>${section}[^<]*</strong>`, 'i');
                content = content.replace(regex, `<h5 class="mt-4 mb-3"><i class="fas fa-info-circle me-2"></i>${section}</h5>`);
            });
            
            // Nettoyer le texte
            content = content.replace(/Rapport sur [^:]+:/, '');
            content = content.replace(/Image :/, '');
            content = content.replace(/Informations sur [^:]+:/, '');
            
            // Ajouter le contenu formatté
            formattedHTML += content;
            
            // Extraire des informations pour les panneaux latéraux
            // Conservation status
            let conservationStatus = "Donnée non disponible pour cette espèce";
            if (text.includes('conservation') || text.includes('UICN') || text.includes('menacée')) {
                const conservationMatch = text.match(/[^.]*(?:conservation|UICN|menacée)[^.]*/);
                if (conservationMatch) {
                    conservationStatus = conservationMatch[0];
                }
            }
            document.getElementById('conservation-status').innerHTML = conservationStatus;
            
            // Habitat en Tunisie
            let habitatInfo = "Cette espèce est présente dans les eaux tunisiennes";
            if (text.includes('Tunisie')) {
                const habitatMatch = text.match(/[^.]*Tunisie[^.]*/);
                if (habitatMatch) {
                    habitatInfo = habitatMatch[0];
                }
            }
            document.getElementById('habitat-info').innerHTML = habitatInfo;
            
            // Recommandations de pêche
            let fishingRecommendations = "Pratiquez une pêche responsable et respectez les tailles minimales de capture.";
            if (text.includes('pêche') || text.includes('capture')) {
                const recommendationsMatch = text.match(/[^.]*(?:pêche|capture|durable)[^.]*/g);
                if (recommendationsMatch && recommendationsMatch.length > 0) {
                    fishingRecommendations = recommendationsMatch.join(' ');
                }
            }
            document.getElementById('fishing-recommendations').innerHTML = fishingRecommendations;
            
            return formattedHTML;
        }
        
        // Soumettre le formulaire de génération d'image
        document.getElementById('image-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const prompt = document.getElementById('prompt').value;
            const loading = document.getElementById('loading');
            const result = document.getElementById('result');
            const imageResult = document.getElementById('generated-image');
            
            // Réinitialiser l'affichage
            loading.classList.remove('d-none');
            result.classList.add('d-none');
            imageResult.src = '';
            imageResult.alt = '';
            
            try {
                const formData = new FormData();
                formData.append('prompt', prompt);
                
                const response = await fetch('/generate-image', {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    throw new Error(`Erreur HTTP: ${response.status}`);
                }
                
                const data = await response.json();
                console.log("Réponse reçue:", data);
                
                // Afficher l'image
                if (data.image_data) {
                    imageResult.src = data.image_data;
                    imageResult.alt = `Image de ${prompt}`;
                } else if (data.image_path) {
                    imageResult.src = `/static/${data.image_path}`;
                    imageResult.alt = `Image de ${prompt}`;
                } else {
                    console.warn("Aucune image reçue dans la réponse");
                    imageResult.src = '/placeholder/600/400';
                }
                
                // Afficher le texte
                if (data.text) {
                    document.getElementById('text-result').innerHTML = formatReport(data.text);
                } else {
                    console.warn("Aucun texte reçu dans la réponse");
                    document.getElementById('text-result').innerHTML = 
                        `<div class="alert alert-warning">Aucune information textuelle n'a été générée pour cette espèce.</div>`;
                }
                
                // Afficher le résultat
                loading.classList.add('d-none');
                result.classList.remove('d-none');
                
            } catch (error) {
                console.error('Erreur:', error);
                loading.classList.add('d-none');
                
                // Afficher un message d'erreur
                document.getElementById('text-result').innerHTML = 
                    `<div class="alert alert-danger">
                        <h5 class="alert-heading">Erreur</h5>
                        <p>${error.message}</p>
                        <p class="mb-0">Veuillez réessayer avec un autre terme.</p>
                    </div>`;
                result.classList.remove('d-none');
            }
        });

        // Charger les conseils de pêche
        function loadFishingTips() {
            // Vérifier si déjà chargé
            if (!document.getElementById('fishing-content').classList.contains('d-none')) {
                return;
            }
            
            document.getElementById('fishing-loading').classList.remove('d-none');
            document.getElementById('fishing-content').classList.add('d-none');
            
            fetch('/fishing-tips')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('fishing-loading').classList.add('d-none');
                    
                    if (data.error) {
                        throw new Error(data.error);
                    }
                    
                    // Formater le texte des conseils
                    const formattedText = data.text
                        .replace(/##\s+(.*)/g, '<h4 class="mt-4 mb-3">$1</h4>')
                        .replace(/###\s+(.*)/g, '<h5 class="mt-3 mb-2">$1</h5>')
                        .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
                        .replace(/\*([^*]+)\*/g, '<em>$1</em>')
                        .replace(/\n\n/g, '<br><br>');
                    
                    document.getElementById('fishing-text').innerHTML = formattedText;
                    
                    const imagesContainer = document.getElementById('fishing-images');
                    imagesContainer.innerHTML = '';
                    
                    if (data.images && data.images.length > 0) {
                        data.images.forEach(imagePath => {
                            const colDiv = document.createElement('div');
                            colDiv.className = 'col-md-4';
                            
                            const cardDiv = document.createElement('div');
                            cardDiv.className = 'fish-card marine-card h-100';
                            
                            const imgElement = document.createElement('img');
                            imgElement.src = `/static/${imagePath}`;
                            imgElement.alt = 'Conseils de pêche';
                            imgElement.className = 'card-img-top';
                            
                            const cardBody = document.createElement('div');
                            cardBody.className = 'card-body';
                            cardBody.innerHTML = '<p class="card-text text-muted">Pêche durable en Tunisie</p>';
                            
                            cardDiv.appendChild(imgElement);
                            cardDiv.appendChild(cardBody);
                            colDiv.appendChild(cardDiv);
                            imagesContainer.appendChild(colDiv);
                        });
                    } else {
                        imagesContainer.innerHTML = '<div class="col-12 text-center text-muted">Aucune image disponible</div>';
                    }
                    
                    document.getElementById('fishing-content').classList.remove('d-none');
                })
                .catch(error => {
                    console.error('Erreur:', error);
                    document.getElementById('fishing-loading').classList.add('d-none');
                    document.getElementById('fishing-text').innerHTML = 
                        `<div class="alert alert-danger">
                            <h5 class="alert-heading">Erreur</h5>
                            <p>${error.message}</p>
                        </div>`;
                    document.getElementById('fishing-content').classList.remove('d-none');
                });
        }
    </script>
</body>
</html>